using System;
using System.Collections.Generic;
using System.IO;
using System.Text.RegularExpressions;
using System.Xml.Linq;
using MonoMod.Utils;
using TFModFortRiseLoaderAI;
using TowerFall;
using System.Linq;

namespace TFModFortRiseAiGraph
{
  internal class AI
  {
    public const string AINAME = "AIJIMMY";
    public static bool isAgentReady = false;
    //private static AISiAgentLevel0[] agents;
    //private static AISiAgentLevel1[] agents;
    public static Agent[] agents;
    //private static AISiAgentLevelTestMovement[] agents;
    public static PlayerInput[] AgentInputs;
    private static MatchSettings matchSettings;
    public static int l1_4_X1 = 2;
    public static int l1_4_Y1 = 2;
    public static int l1_4_X2 = 2;
    public static int l1_4_Y2 = 2;
    public static String s = "";

    public static void CreateAgent()
    {
      if (isAgentReady) return;
      //detect first player slot free
      int max = TFModFortRiseAiSimpleModule.EightPlayerMod ? 8 : 4;

      //agents = new AISiAgentLevel0[max];
      //agents = new AISiAgentLevel1[max];
      agents = new Agent[max];
      //agents = new AISiAgentLevelTestMovement[max];
      AgentInputs = new PlayerInput[max];

      for (int i = 0; i < max; i++)
      {
        // create an agent for each player
        AgentInputs[i] = new TFModFortRiseLoaderAI.Input(i);
        //agents[i] = new AISiAgentLevel0(i, AINAME, AgentInputs[i]);
        //agents[i] = new AISiAgentLevel1(i, AINAME, AgentInputs[i]);
        agents[i] = new Agent(i, AINAME, AgentInputs[i]);
        //agents[i] = new AISiAgentLevelTestMovement(i, AINAME, AgentInputs[i]);
        Logger.Info("Agent " + AINAME + " " + i + " Created");
      }


      //SANDBOX  (had to set PlayerInputs before addAgent()!!)
      //TFGame.PlayerInputs[0] = null; //for HUMAN with keybaord or gamepad connected
      if (MyTFGame.sandbox)
      {
        TFGame.PlayerInputs[1] = null;
        TFGame.PlayerInputs[2] = null;
        TFGame.PlayerInputs[3] = null;
      }
      //SANDBOX  (had to set PlayerInputs before addAgent()!!)

      isAgentReady = true;
      //Logger.Info("addAgent1");
      LoaderAIImport.addAgent(AINAME, agents);
      //Logger.Info("addAgent2");


      //SANDBOX  (had to set PlayerInputs before addAgent()!!)
      if (MyTFGame.sandbox)
      {
        //AGENT 0 = HUMAN (keyboard or gamepad)
        TFGame.Players[0] = true;
        //TFGame.PlayerInputs[0] = agents[0].getInput();
        TFGame.Characters[0] = 0;
        TFGame.AltSelect[0] = ArcherData.ArcherTypes.Normal;

        //AGENT 1 = AISi
        TFGame.Players[1] = true;
        TFGame.PlayerInputs[1] = agents[1].getInput();
        TFGame.Characters[1] = 1;
        TFGame.AltSelect[1] = ArcherData.ArcherTypes.Normal;

        ////base.MainMenu.State = MainMenu.MenuState.Main;
        //StartNewSession();
      }
      //SANDBOX

    }

    public static void StartNewSession()
    {
      Logger.Info("Starting a new session.");
      CreateMatchSettings();
      Session session = new Session(matchSettings);
      //session.QuestTestWave = 1;
      session.StartGame();
      Logger.Info("Session started.");
    }


    public static void CreateMatchSettings()
    {
      Logger.Info("CreateMatchSettings.");
      //if (!IsNoConfig)
      //{
      //  Config = JsonConvert.DeserializeObject<MatchConfig>(File.ReadAllText(ConfigPath));
      //}
      MatchSettings.MatchLengths matchLength;
      //matchLength = MatchSettings.MatchLengths.Instant;
      //matchLength = MatchSettings.MatchLengths.Quick;
      //matchLength = MatchSettings.MatchLengths.Epic;
      matchLength = MatchSettings.MatchLengths.Standard;
      //System.Random rnd = new Random();
      //LevelSystem levelSystem = GameData.VersusTowers[rnd.Next(1, 17)].GetLevelSystem(); //16 levels;
      ////Logger.Info("Configuring HeadHunters mode.");
      //matchSettings = new MatchSettings(levelSystem, Modes.HeadHunters, matchLength);
      //matchSettings.Variants.TournamentRules();

      Logger.Info("Configuring Sandbox mode.");
      matchSettings = MatchSettings.GetDefaultTrials();
      matchSettings.Mode = Modes.LevelTest;

      //LevelSystem levelSystem = GameData.VersusTowers[1].GetLevelSystem();
      //matchSettings = new MatchSettings(levelSystem, Modes.HeadHunters, matchLength);
      //matchSettings.Variants.TournamentRules();

      //ok
      String s0 = @"
11111111111111111111111111111111
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
11111111111111111111111111111111";

      String s1 = @"
11111111111111111110011111111111
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
11111111111111111110011111111111";

      String s2 = @"
11111111111111111000011111111111
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
11111111111111111000011111111111";

      String sko1 = @"
11111111111111100000011111111111
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
11111111111111100000011111111111";

      String s4 = @"
11111111111111111111111111111111
10000000000000000000000000100001
10000000000000000000000000100001
10000000000000000000000110100001
10000000000000000000011000100011
11100000000000000001100000100001
10000000000000000110000000100001
10000000000000011000000000100001
10000000000001100000000000100001
00000000000110000000000000100000
00000000000000000000000000100000
11110000000000000000000000100001
10000000000000000000000000100001
10000000000000000000000000100001
10000000000110000000000000100001
10000000000000000000000000000001
11111000000000000000000000000001
10000000000000000000011111111111
10000000000110000000000000000001
10000000000000000000000000000001
11111110000000000010000000000001
00000000000000010010010000000000
00000000000010010010010010000000
11111111111111111111111111111111";

      String sTir = @"
11111111111111111111111111111111
10000000000000000000000000000001
10000000000000000000000000000001
10100000000000000000000000000001
10000000000000000000000000000001
10100000000000000000000000000001
10000000000000000000000000000001
10100000000000000000000000000001
10000000000000000000000000000001
10100000000000000000000000000001
10000000000000000000000000000001
10100000000000000000000000000001
10000000000000000000000000000001
10100000000000000000000000000001
10000000000000000000000000000001
10100000000000000000000000000001
10011111111111111111111111111111
10100000000000000000000000000001
10000000000000000000000000000001
10101010101010101010101010111111
10000000000000000000000000010001
10000000000000000000000000010001
10000000000000000000000000010001
11111111111111111111111111111111";

      //public float testActionX = 305;
      //public float testActionY = 222;
      String sjumpright_m1m1 = @"
11111111111111111111111111111111
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000111
10000000000000000000000000000001
10000000000000000000000000000001
10000000100000000000000000000101
11111111111111111111111111111111";

      String sjumpright_m2m1 = @"
11111111111111111111111111111111
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000111
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10110000100000000000000000001101
11111111111111111111111111111111";

      String sleftmNm0 = @"
11111111111111100111111111111111
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000100001
10000000000000000000000000100001
11111111111111100111100011111111";

      String sjumpleftmNm0 = @"
11000000001111111111110000000011
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
11111111000000000000000011111111
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
11000000001111111111110000000011";

      String jumpbloc = @"
11000000001111111111110000000011
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10100000000000000000000000000001
10100000000000000000000000000001
10100000000000000000000000000001
10100000000000000000000000000001
10100000000000000000000000001001
10100000000000000000000000001001
10100000000000000000000000001001
10100000000000000000000000001001
11111111111111111111111111111111";

      String jumpblocdiagonale = @"
11000000001111111111110000000011
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000001111111
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000001110001
10000000000000000000000011111001
10000000000000000000000111111001
11111111111111111111110000000011";

      String jumpblocdiagonale2 = @"
11000000001111111111110000000011
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000000000000001
10000000000000000000011111000001
10000000000000000000011111100001
10000000000000000000011111110001
10000000000000000000011111111001
10000000000000000000011111111101
11111111111111111111111111111111";

      String dash = @"
11000000001111111111110000000001
10000000000000000000000000001001
10000000000000000000000000000001
10000000000000000000000000001001
10000000000000000000000000000001
10000000000000000000000000001001
10000000000000000000000000000001
10000000000000000000000000001001
10000000000000000000000000000001
10000000000000000000011111111001
10000000000000000000011111110001
10000000000000000000011111111001
10000000000000000000000000000001
10000000000000000000000000001001
10000000000000000000000000000001
10000000000000000000000000001001
10000000000000000000000000000001
10000000000000000000000000001001
10000000000000000000011111000001
10000000000000000000011111101001
10000000000000000000000000010001
10000000000000000000000000001001
10000000000000000000000000000001
11111111111111111111111111111111";

      ///////////////////////////////
      //matchSettings.LevelSystem = new SandboxLevelSystem(GameData.QuestLevels[0], convertToStringToArray(dash));
      //matchSettings.LevelSystem = new  SandboxLevelSystem(GameData.QuestLevels[0], convertToStringToArray(jumpblocdiagonale2));
      //matchSettings.LevelSystem = new  SandboxLevelSystem(GameData.QuestLevels[0], convertToStringToArray(dash));
      ///////////////////////////////
      LoadLevel("01_02");
      matchSettings.LevelSystem = new SandboxLevelSystem(GameData.QuestLevels[0], convertToStringToArray(s));
      ///////////////////////////////
      Logger.Info("set NoTreasure");
      matchSettings.Variants.NoTreasure.Value = true;

      for (int i = 0; i < agents.Length; i++)
      {
        matchSettings.Teams[i] = Allegiance.Neutral;
      }

      //hide the intro control for level 0 or trigger controle for tower N
      var dynData = DynamicData.For(matchSettings.LevelSystem);
      dynData.Set("ShowControls", false);
      dynData.Set("ShowTriggerControls", false);
      dynData.Dispose();
    }

    public static int[,] convertToStringToArray(string s)
    {
      string[] lines = Regex.Split(s.Trim(), "\n");
      int rows = lines.Length;
      int cols = lines[0].Trim().Length;
      int[,] array = new int[rows, cols];
      for (int i = 0; i < rows; i++)
      {
        string line = lines[i].Trim();
        for (int j = 0; j < cols; j++)
        {
          array[i, j] = (int)char.GetNumericValue(line[j]);
        }
      }
      return array;
    }

    static void LoadLevel(string code)
    {
      // code est du style "01_02"
      string[] parts = code.Split('_');
      if (parts.Length != 2)
        throw new ArgumentException("Format attendu : 01_02");

      string folder = parts[0]; // "01"
      string filename = parts[1] + ".oel";

      string baseDir = "./Content/Levels/Versus/";

      if (!Directory.Exists(baseDir))
        throw new DirectoryNotFoundException("Dossier Versus introuvable : " + baseDir);

      // Recherche du dossier commençant par "01 -"
      string prefix = folder + " -";

      string[] allDirs = Directory.GetDirectories(baseDir);
      string levelDir = null;

      foreach (string d in allDirs)
      {
        string name = Path.GetFileName(d);
        if (name.StartsWith(prefix))
        {
          levelDir = d;
          break;
        }
      }

      if (levelDir == null)
        throw new DirectoryNotFoundException("Aucun dossier ne commence par '" + prefix + "' dans " + baseDir);

      // Construction du chemin final
      string path = Path.Combine(levelDir, filename);

      if (!File.Exists(path))
        throw new FileNotFoundException("Impossible de trouver le fichier de niveau", path);

      // Chargement XML
      XDocument xml = XDocument.Load(path);

      // --- LECTURE DES SOLIDS ---
      XElement solidsElement = xml.Root.Element("Solids");
      if (solidsElement == null)
        throw new Exception("Balise <Solids> introuvable dans le fichier");

      s = solidsElement.Value.Trim();

      // --- LECTURE DES PLAYERSPAWN ---
      XElement entities = xml.Root.Element("Entities");
      if (entities == null)
        throw new Exception("Balise <Entities> introuvable");

      IEnumerable<XElement> spawns = entities.Elements("PlayerSpawn");
      List<XElement> spawnList = spawns.ToList();

      if (spawnList.Count < 2)
        throw new Exception("Pas assez de PlayerSpawn pour placer deux joueurs.");

      // Choix des 2 premiers spawns
      XElement p1 = spawnList[0];
      XElement p2 = spawnList[1];

      // Lecture et conversion en int
      int x1 = (int)float.Parse(p1.Attribute("x").Value);
      int y1 = (int)float.Parse(p1.Attribute("y").Value);
      int x2 = (int)float.Parse(p2.Attribute("x").Value);
      int y2 = (int)float.Parse(p2.Attribute("y").Value);

      l1_4_X1 = x1;
      l1_4_Y1 = y1;
      l1_4_X2 = x2;
      l1_4_Y2 = y2;

      // Debug console si utile
      Console.WriteLine("Niveau chargé : " + path);
      Console.WriteLine("Solids :");
      Console.WriteLine(s);
    }
  }
}
